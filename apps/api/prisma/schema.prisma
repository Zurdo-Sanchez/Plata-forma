generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum LoginAttemptStatus {
  SUCCESS
  FAILED
  BLOCKED
}

enum LoginAlertType {
  LOCKOUT
}

enum HouseholdRole {
  OWNER
  MEMBER
}

enum AccountType {
  BANK
  CASH
  CREDIT_CARD
  LOAN
}

enum CategoryType {
  INCOME
  EXPENSE
  TRANSFER
}

model User {
  id             String            @id @default(uuid()) @db.Char(36)
  email          String            @unique @db.VarChar(255)
  passwordHash   String            @map("password_hash") @db.VarChar(255)
  passwordSalt   String            @map("password_salt") @db.VarChar(255)
  isSuperAdmin   Boolean           @default(false) @map("is_super_admin")
  failedAttempts Int               @default(0) @map("failed_attempts")
  lockedUntil    DateTime?         @map("locked_until")
  lastLoginAt    DateTime?         @map("last_login_at")
  createdAt      DateTime          @default(now()) @map("created_at")
  updatedAt      DateTime          @updatedAt @map("updated_at")

  loginAttempts  AuthLoginAttempt[]
  loginAlerts    AuthLoginAlert[]
  memberships    HouseholdMember[]

  @@map("auth_users")
}

model Household {
  id        String             @id @default(uuid()) @db.Char(36)
  name      String             @db.VarChar(120)
  currency  String?            @db.VarChar(3)
  createdAt DateTime           @default(now()) @map("created_at")
  updatedAt DateTime           @updatedAt @map("updated_at")

  members     HouseholdMember[]
  accounts    Account[]
  categories  Category[]
  transactions Transaction[]
  creditCards CreditCard[]
  loans       Loan[]

  @@map("households")
}

model HouseholdMember {
  id          Int           @id @default(autoincrement())
  householdId String        @map("household_id") @db.Char(36)
  userId      String        @map("user_id") @db.Char(36)
  role        HouseholdRole @default(MEMBER)
  createdAt   DateTime      @default(now()) @map("created_at")

  household Household @relation(fields: [householdId], references: [id])
  user      User      @relation(fields: [userId], references: [id])

  @@unique([householdId, userId])
  @@index([userId])
  @@map("household_members")
}

model Account {
  id         String       @id @default(uuid()) @db.Char(36)
  householdId String      @map("household_id") @db.Char(36)
  name       String       @db.VarChar(120)
  type       AccountType
  currency   String?      @db.VarChar(3)
  isActive   Boolean      @default(true) @map("is_active")
  createdAt  DateTime     @default(now()) @map("created_at")
  updatedAt  DateTime     @updatedAt @map("updated_at")

  household   Household       @relation(fields: [householdId], references: [id])
  lines       TransactionLine[]
  creditCard  CreditCard?
  loan        Loan?

  @@index([householdId])
  @@map("accounts")
}

model Category {
  id          String       @id @default(uuid()) @db.Char(36)
  householdId String       @map("household_id") @db.Char(36)
  name        String       @db.VarChar(120)
  type        CategoryType
  isActive    Boolean      @default(true) @map("is_active")
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  household Household       @relation(fields: [householdId], references: [id])
  lines     TransactionLine[]

  @@index([householdId])
  @@unique([householdId, name])
  @@map("categories")
}

model Transaction {
  id          String      @id @default(uuid()) @db.Char(36)
  householdId String      @map("household_id") @db.Char(36)
  date        DateTime    @db.DateTime(0)
  description String?     @db.VarChar(255)
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  household Household        @relation(fields: [householdId], references: [id])
  lines     TransactionLine[]

  @@index([householdId, date])
  @@map("transactions")
}

model TransactionLine {
  id            Int        @id @default(autoincrement())
  transactionId String     @map("transaction_id") @db.Char(36)
  accountId     String     @map("account_id") @db.Char(36)
  categoryId    String?    @map("category_id") @db.Char(36)
  amount        BigInt     @db.BigInt
  memo          String?    @db.VarChar(255)
  createdAt     DateTime   @default(now()) @map("created_at")

  transaction Transaction @relation(fields: [transactionId], references: [id])
  account     Account     @relation(fields: [accountId], references: [id])
  category    Category?   @relation(fields: [categoryId], references: [id])

  @@index([transactionId])
  @@index([accountId])
  @@index([categoryId])
  @@map("transaction_lines")
}

model CreditCard {
  id          String     @id @default(uuid()) @db.Char(36)
  householdId String     @map("household_id") @db.Char(36)
  accountId   String     @unique @map("account_id") @db.Char(36)
  name        String     @db.VarChar(120)
  closingDay  Int        @map("closing_day")
  dueDay      Int        @map("due_day")
  limitAmount BigInt?    @map("limit_amount") @db.BigInt
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")

  household Household @relation(fields: [householdId], references: [id])
  account   Account   @relation(fields: [accountId], references: [id])

  @@index([householdId])
  @@map("credit_cards")
}

model Loan {
  id              String   @id @default(uuid()) @db.Char(36)
  householdId     String   @map("household_id") @db.Char(36)
  accountId       String   @unique @map("account_id") @db.Char(36)
  name            String   @db.VarChar(120)
  principalAmount BigInt   @map("principal_amount") @db.BigInt
  interestRateBps Int      @map("interest_rate_bps")
  startDate       DateTime @map("start_date") @db.DateTime(0)
  termMonths      Int?     @map("term_months")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  household Household @relation(fields: [householdId], references: [id])
  account   Account   @relation(fields: [accountId], references: [id])

  @@index([householdId])
  @@map("loans")
}

model AuthLoginAttempt {
  id        Int                @id @default(autoincrement())
  userId    String?            @map("user_id") @db.Char(36)
  email     String             @db.VarChar(255)
  ip        String?            @db.VarChar(45)
  userAgent String?            @map("user_agent") @db.VarChar(255)
  status    LoginAttemptStatus
  createdAt DateTime           @default(now()) @map("created_at")

  user User? @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([email])
  @@index([createdAt])
  @@map("auth_login_attempts")
}

model AuthLoginAlert {
  id        Int             @id @default(autoincrement())
  userId    String?         @map("user_id") @db.Char(36)
  email     String          @db.VarChar(255)
  type      LoginAlertType
  message   String?         @db.VarChar(255)
  createdAt DateTime        @default(now()) @map("created_at")

  user User? @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([email])
  @@index([createdAt])
  @@map("auth_login_alerts")
}
